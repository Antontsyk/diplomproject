<% include partials/head %>

  <body>
<!--Header-->
<% include partials/header.ejs %>
<!--End Header-->
<div id="container" class="slideshow">

  <!--Set your own slider options. Look at the v_RevolutionSlider() function in 'theme-core.js' file to see options-->
  <div class="fullwidthbanner-container" id="home">

    <div
            id="map"
            data-bgposition="center top"
            data-bgfit="cover"
            data-bgrepeat="no-repeat"
            style="width: 100%; height: 400px;"
    >

    </div>
    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <input id="pac-input" class="controls" type="text"
                 placeholder="Введите место">
          <div id="type-selector" class="controls">
            <input type="radio" name="type" id="changetype-all" checked="checked">
            <label for="changetype-all">Все</label>

            <input type="radio" name="type" id="changetype-establishment">
            <label for="changetype-establishment">Учреждения</label>

            <input type="radio" name="type" id="changetype-address">
            <label for="changetype-address">Адреса</label>

            <input type="radio" name="type" id="changetype-geocode">
            <label for="changetype-geocode">геокодов</label>
          </div>
        </div>
      </div>
          <% if (user != null) { %>
        <br>
        <form id="setLocation">
            <input type="hidden" name="idUser" value="<%= user._id ? user._id : '' %>">
            <input type="hidden" name="location_lat" id="location_place_lat">
            <input type="hidden" name="location_lng" id="location_place_lng">
            <div class="row">
                <div class="col-md-9">
                    <div class="row">
                        <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                            <input type="text" name="name" class="form-control" id="name_location" placeholder="Название">
                        </div>
                        <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                            <select class="form-control" id="category" required>
                                <option value="" disabled selected hidden>Категория</option>
                                <option value="2">
                                    Авто. Мото
                                </option><option value="3">
                                    Бытовые услуги
                                </option><option value="4">
                                    Еда
                                </option><option value="5">
                                    Здоровье и спорт
                                </option><option value="6">
                                    Интерьер
                                </option><option value="1">
                                    Информационные технологии
                                </option><option value="7">
                                    Коммерция
                                </option><option value="8">
                                    Культура
                                </option><option value="9">
                                    Логистика
                                </option><option value="10">
                                    Мода и стиль
                                </option><option value="11">
                                    Ноухау
                                </option><option value="12">
                                    Образование
                                </option><option value="13">
                                    Промышленное производство
                                </option><option value="14">
                                    Развлечения. Отдых
                                </option><option value="15">
                                    Сельское хозяйство
                                </option><option value="16">
                                    Социальные проекты
                                </option><option value="17">
                                    Строительство
                                </option><option value="18">
                                    Туризм
                                </option><option value="19">
                                    Финансы
                                </option><option value="20">
                                    Экология
                                </option></select>
                        </div>
                        <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                            <input class="form-control" type="text" disabled id="location_map" placeholder="Место на карте" required>
                        </div>
                        <!--Toggle-->
                        <div class="col-sm-12">
                                <div class="v-heading-v2">
                                    <h3>Заполните ещё немного</h3>
                                </div>

                                <div class="panel-group">
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle collapsed" data-toggle="collapse" href="#collapseOnex">
                                                    <i class="fa fa-edit"></i>
                                                    Дополнительные поля
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapseOnex" class="accordion-body collapse">
                                            <div class="panel-body">
                                                <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                                                    <select class="form-control">
                                                        <option value="" disabled selected hidden>Кол-во основателей</option>
                                                        <option>2</option>
                                                        <option>3</option>
                                                        <option>4</option>
                                                        <option>5 и более</option>
                                                    </select>
                                                </div>
                                                <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                                                    <select class="form-control">
                                                        <option value="" disabled selected hidden>Стадия проекта</option>
                                                        <option>Идея</option>
                                                        <option>MVP\Beta</option>
                                                        <option>Недавно запустились</option>
                                                        <option>Активно развиваемся</option>
                                                    </select>
                                                </div>
                                                <div class="p-y-xs col-md-4 col-sm-6 col-xs-12">
                                                    <select class="form-control">
                                                        <option value="" disabled selected hidden>Что требуется</option>
                                                        <option>Деньги</option>
                                                        <option>Экспертиза</option>
                                                        <option>Инфраструктура</option>
                                                        <option>Сервисы</option>
                                                    </select>
                                                </div>
                                                <div class="col-xs-12 p-y-xs">
                                                    <textarea class="form-control" rows="3" id="textareaDefault" placeholder="От себя..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <!--End Toggle-->
                    </div>
                </div>
                <div class="col-md-3 p-y-xs">
                    <button type="submit" class="btn v-btn v-emerald btn-block">Сохранить</button>
                </div>
            </div>

            <div class="v-spacer col-sm-12 v-height-big"></div>


        </form>
          <% } else {%>
          <div class="clo-xs-12 center">
              <br>
              <br>
            <a href="/login" class="btn v-btn v-emerald">Войти чтобы оставить отметку</a>
          </div>
          <% } %>
        <div class="col-xs-12" id="demo">

                <div id="search" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Поиск</label>
                        <div class="col-sm-10">
                            <p class="form-control-static"><input name="query" v-model="searchQuery" type="text" class="form-control" placeholder="Введите название проекта"></p>
                        </div>
                    </div>
                </div>
                <div style="max-height: 300px;overflow: auto;">
                    <demo-grid
                            :data="gridData"
                            :columns="gridColumns"
                            :filter-key="searchQuery">
                    </demo-grid>
                </div>
            </div>

      </div>
    </div>
    <br>
    <br>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAO3k8FN3DKN0lL1-ryTKG-dnFO_KFxyi4&libraries=places"></script>
    <script>

        function selectCategoty(id) {
            switch (Number(id)) {
                case 1: return 'Информационные технологии'
                    break;
                case 2: return 'Авто. Мото'
                    break;
                case 3: return 'Бытовые услуги'
                    break;
                case 4: return 'Еда'
                    break;
                case 5: return 'Здоровье и спорт'
                    break;
                case 6: return 'Интерьер'
                    break;
                case 7: return 'Коммерция'
                    break;
                case 8: return 'Культура'
                    break;
                case 9: return 'Логистика'
                    break;
                case 10: return 'Мода и стиль'
                    break;
                case 11: return 'Ноухау'
                    break;
                case 12: return 'Образование'
                    break;
                case 13: return 'Промышленное производство'
                    break;
                case 14: return 'Развлечения. Отдых'
                    break;
                case 15: return 'Сельское хозяйство'
                    break;
                case 16: return 'Социальные проекты'
                    break;
                case 17: return 'Строительство'
                    break;
                case 18: return 'Туризм'
                    break;
                case 19: return 'Финансы'
                    break;
                case 20: return 'Экология'
                    break;
                default: return 'NOT'
            }
        }
        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">
        var locations = [];
        <% if (user != null) { %>
        <% } %>
        var All_locations = [
            <% for( var i = 0; i < users.length; i++){  %>
            <% for( var j=0; j < users[i].local.locations.length; j++) {  %>
            {
                name: '<%= users[i].local.locations[j].name %>',
                place: {
                    lat: <%= users[i].local.locations[j].place.lat %>,
                    lng: <%= users[i].local.locations[j].place.lng %>
                },
                category: <%= users[i].local.locations[j].category %>
            },
            <% }%>
            <% }%>
        ];
        //var locations = JSON.parse(localStorage.pos);
        var map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 53.9085624, lng: 27.548442199999954},
                zoom: 6
            });

            var input = /** @type {!HTMLInputElement} */(
                document.getElementById('pac-input'));

            var types = document.getElementById('type-selector');
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(types);

            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            var infowindow = new google.maps.InfoWindow();
            var marker = new google.maps.Marker({
                map: map,
                anchorPoint: new google.maps.Point(0, -29)
            });

            autocomplete.addListener('place_changed', function() {
                infowindow.close();
                marker.setVisible(false);
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }

                // If the place has a geometry, then present it on a map.
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                }
                marker.setIcon(/** @type {google.maps.Icon} */({
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(35, 35)
                }));
                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                var address = '';
                //var location = JSON.parse(localStorage.pos);

                if (place.address_components) {
                    address = [
                        (place.address_components[0] && place.address_components[0].short_name || ''),
                        (place.address_components[1] && place.address_components[1].short_name || ''),
                        (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                    //location.push(place)
                    document.getElementById('location_map').value = address;
                    document.getElementById('location_place_lat').value = place.geometry.location.lat();
                    document.getElementById('location_place_lng').value = place.geometry.location.lng();

                    //localStorage.setItem('pos', JSON.stringify(location) );
                }

                infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
                infowindow.open(map, marker);
            });

            // Sets a listener on a radio button to change the filter type on Places
            // Autocomplete.
            function setupClickListener(id, types) {
                var radioButton = document.getElementById(id);
                radioButton.addEventListener('click', function() {
                    autocomplete.setTypes(types);
                });
            }

            setupClickListener('changetype-all', []);
            setupClickListener('changetype-address', ['address']);
            setupClickListener('changetype-establishment', ['establishment']);
            setupClickListener('changetype-geocode', ['geocode']);
        }
        initMap();

        var infoWindow = new google.maps.InfoWindow();

        function addMarker(location, category) {
            var marker = new google.maps.Marker({
                position: location,
                label: selectCategoty(category),
                map: map
            });
            google.maps.event.addListener(marker, 'click', (function(marker) {
                return function() {
                    infoWindow.setContent(selectCategoty(category));
                    infoWindow.open(map, marker);
                }
            })(marker))
            markers.push(marker);
        }

        function createContent( obj ){
            var contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">Название: '+obj.name+'</h1>'+
                '<h2>Категория: '+selectCategoty(obj.category)+'</h2>'+
                '<div id="bodyContent">'+
                '<p>Описание: </p>'+
                '</div>'+
                '</div>';
            return contentString;
        }

        var markers = All_locations.map(function( position , i) {
            return new google.maps.Marker({
                position: position.place,
                label: position.name
            });
        });

        markers.map(function ( marker, i ) {
            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infoWindow.setContent(createContent(All_locations[i]));
                    infoWindow.open(map, marker);
                }
            })(marker, i));
        });

        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
    </script>

    <div class="shadow-right"></div>
  </div>


  <!--Footer-Wrap-->
  <% include partials/footer.ejs %>
  <!--End Footer-Wrap-->
</div>

<!--// BACK TO TOP //-->
<div id="back-to-top" class="animate-top"><i class="fa fa-angle-up"></i></div>

<!-- Libs -->
<% include partials/include_scripts.ejs %>
<script type="text/x-template" id="grid-template">
    <table  class="table table-striped tableSearch">
        <thead>
        <tr>
            <th v-for="key in columns"
                @click="sortBy(key)"
                :class="{ active: sortKey == key }">
                {{ key | capitalize }}
                <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
                                      </span>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="entry in filteredData">
            <td v-for="key in columns">
                {{ key =='category'?selectCategoty(entry[key]):entry[key]  }}
            </td>
        </tr>
        </tbody>
    </table>
</script>
<script>
Vue.component('demo-grid', {
  template: '#grid-template',
  props: {
    data: Array,
    columns: Array,
    filterKey: String
  },
  data: function () {
    var sortOrders = {}
    this.columns.forEach(function (key) {
      sortOrders[key] = 1
    })
    return {
      sortKey: '',
      sortOrders: sortOrders
    }
  },
  computed: {
    filteredData: function () {
      var sortKey = this.sortKey
      var filterKey = this.filterKey && this.filterKey.toLowerCase()
      var order = this.sortOrders[sortKey] || 1
      var data = this.data
      if (filterKey) {
        data = data.filter(function (row) {
          return Object.keys(row).some(function (key) {
            return String(row[key]).toLowerCase().indexOf(filterKey) > -1
          })
        })
      }
      if (sortKey) {
        data = data.slice().sort(function (a, b) {
          a = a[sortKey]
          b = b[sortKey]
          return (a === b ? 0 : a > b ? 1 : -1) * order
        });
      }

      var nameArray = [];
      data.map(function ( elem ) {
         nameArray.push(elem.name);
      });

      var markersFilterArray = [];

        markerCluster.clearMarkers();
        markers.map(function ( marker, i ) {
            var view = (nameArray.indexOf(marker.label) != -1) ? true : false;
            marker.setVisible( view );
            if( view ){
                markersFilterArray.push(marker);
            }
        });

        markerCluster.addMarkers(markersFilterArray);

      return data
    }
  },
  filters: {
    capitalize: function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }
  },
  methods: {
    selectCategoty: function ( id ){
        return window.selectCategoty(id);
    },
    sortBy: function (key) {
      this.sortKey = key
      this.sortOrders[key] = this.sortOrders[key] * -1
    }
  }
})

// bootstrap the demo
var demo = new Vue({
  el: '#demo',
  data: {
    searchQuery: '',
    gridColumns: ['name', 'category'],
    gridData: All_locations
  }
})
</script>
<script>

    <% if (user != null) { %>
  $('form[id=setLocation]').submit(function (e) {
      e.preventDefault();
      e.stopPropagation();
        if(!$('#location_map').val()){
            $('#pac-input').addClass('error');
            alert('Выберите месторасположение!');
        }else{
            $('#pac-input').removeClass('error');
            var lat = Number(document.getElementById('location_place_lat').value);
            var lng = Number(document.getElementById('location_place_lng').value);
            var category = document.getElementById('category').value;
            var name = document.getElementById('name_location').value;
            $.ajax({
                type: 'POST',
                url: '/setLocation',
                crossDomain: true,
                headers:{
                    'Access-Control-Allow-Origin':'*'
                },
                data: {
                    idUser: '<%= user._id ? user._id : '' %>',
                    location_lat: lat,
                    location_lng: lng,
                    category: category,
                    name: name
                },
                success: function(data){
                    console.log(data);
                    addMarker({ lat: lat, lng: lng }, category);
                    console.log({ lat: lat, lng: lng }, category);
                    map.setZoom(6);
                    alert('Ваша точка успешно добавлена!');
                },
                error: function(data){
                    alert('Что-то пошло не так!');
                }
            });
        }
  });

  <% } %>

</script>
</body>
</html>
